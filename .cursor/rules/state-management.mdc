---
description: SwiftUI state management rules - proper usage of @State, @StateObject, @ObservedObject, @Published, and @Binding with practical examples
alwaysApply: false
tags: [swiftui, state, reactive, observableobject, binding]
relatedDocs:
  - Documentation/2_Architecture/STATE_MANAGEMENT.md
  - Documentation/2_Architecture/DATA_FLOW.md
version: 1.0
lastUpdated: 2025-10-30
---
# SwiftUI State Management Rules

**Reference**: `Documentation/2_Architecture/STATE_MANAGEMENT.md`

## üéØ Property Wrapper Quick Reference

| Wrapper | Use When | Scope | Example |
|---------|----------|-------|---------|
| `@State` | Local view state | Single view | `@State private var isVisible = false` |
| `@StateObject` | View owns object | View lifecycle | `@StateObject private var manager = Manager()` |
| `@ObservedObject` | View observes object | Parent owns | `@ObservedObject var manager: Manager` |
| `@Published` | Observable property | Inside ObservableObject | `@Published var value = ""` |
| `@Binding` | Two-way binding | Parent ‚Üî Child | `@Binding var isEnabled: Bool` |

## üìã Rules by Property Wrapper

### @State - Local View State

**When**: Simple, private state within a single view

```swift
// ‚úÖ GOOD - Local UI state
struct MyView: View {
    @State private var showSheet = false
    @State private var textInput = ""
    @State private var selectedIndex = 0
    
    var body: some View {
        Button("Show") { showSheet.toggle() }
    }
}

// ‚ùå BAD - Complex object in @State
struct MyView: View {
    @State private var manager = ComplexManager()  // NO! Use @StateObject
}
```

**Rules**:
- ‚úÖ Use `private` access control
- ‚úÖ Simple value types (Bool, String, Int)
- ‚ùå Never for ObservableObjects
- ‚ùå Don't pass @State directly (use $binding)

### @StateObject - View Owns ObservableObject

**When**: View creates and owns the lifecycle

```swift
// ‚úÖ GOOD - View owns manager
struct ContentView: View {
    @StateObject private var compositionManager = CompositionManager()
    
    var body: some View {
        CameraView(manager: compositionManager)
    }
}

// ‚ùå BAD - Using @ObservedObject to create
struct ContentView: View {
    @ObservedObject var manager = Manager()  // NO! Use @StateObject
}
```

**Rules**:
- ‚úÖ View creates the object
- ‚úÖ Object persists across view updates
- ‚úÖ Use for managers, coordinators
- ‚ùå Don't use @ObservedObject to create objects

**From Klick** (`ContentView.swift:12`):

```swift
@StateObject private var compositionManager = CompositionManager()
```

### @ObservedObject - View Observes (Doesn't Own)

**When**: Object is passed from parent

```swift
// ‚úÖ GOOD - Passed from parent
struct ChildView: View {
    @ObservedObject var manager: CompositionManager
    
    var body: some View {
        Text(manager.currentType.rawValue)
    }
}

// Parent passes it
struct ParentView: View {
    @StateObject private var manager = CompositionManager()
    
    var body: some View {
        ChildView(manager: manager)  // Pass to child
    }
}
```

**Rules**:
- ‚úÖ Object is passed from parent
- ‚úÖ Parent manages lifecycle
- ‚ùå Don't create objects with @ObservedObject

**From Klick** (`CameraView.swift:68`):

```swift
@ObservedObject var compositionManager: CompositionManager
```

### @Published - Observable Properties

**When**: Inside ObservableObject, triggers UI updates

```swift
// ‚úÖ GOOD - Observable properties
class CompositionManager: ObservableObject {
    @Published var currentType: CompositionType = .ruleOfThirds
    @Published var isEnabled = true
    @Published var lastResult: CompositionResult?
    
    func switchType(_ type: CompositionType) {
        currentType = type  // Automatically triggers UI update
    }
}

// ‚ùå BAD - All properties published
class Manager: ObservableObject {
    @Published var tempValue = 0  // Doesn't need to trigger UI
    @Published var cache: [String: UIImage] = [:]  // Too expensive
}
```

**Rules**:
- ‚úÖ Only for properties that affect UI
- ‚úÖ Inside ObservableObject classes
- ‚ùå Don't publish everything
- ‚ùå Avoid expensive computed properties

**From Klick** (`CompositionManager.swift:11-15`):

```swift
@Published var currentCompositionType: CompositionType = .ruleOfThirds
@Published var isEnabled = true
@Published var lastResult: CompositionResult?
```

### @Binding - Two-Way Data Binding

**When**: Child needs to modify parent's state

```swift
// ‚úÖ GOOD - Two-way binding
// Parent
struct ParentView: View {
    @State private var isEnabled = true
    
    var body: some View {
        SettingsView(isEnabled: $isEnabled)  // Pass with $
    }
}

// Child
struct SettingsView: View {
    @Binding var isEnabled: Bool
    
    var body: some View {
        Toggle("Enable", isOn: $isEnabled)  // Can read & write
    }
}
```

**Rules**:
- ‚úÖ Pass with `$` prefix from parent
- ‚úÖ Child can read and write
- ‚úÖ Use for simple state sharing
- ‚ùå Don't use for complex objects (use @ObservedObject)

**From Klick** (`CameraView.swift:57-62`):

```swift
@Binding var triggerCapture: Bool
@Binding var isFacialRecognitionEnabled: Bool
```

## üîÑ Common State Flow Patterns

### Pattern 1: Parent ‚Üí Child (Read-Only)

```swift
// Parent owns state
struct ParentView: View {
    @State private var value = "Hello"
    
    var body: some View {
        ChildView(text: value)  // Pass as property
    }
}

// Child reads only
struct ChildView: View {
    let text: String
    var body: some View { Text(text) }
}
```

### Pattern 2: Parent ‚Üî Child (Two-Way)

```swift
// Parent owns state
struct ParentView: View {
    @State private var value = ""
    
    var body: some View {
        ChildView(text: $value)  // Pass as binding
    }
}

// Child can modify
struct ChildView: View {
    @Binding var text: String
    var body: some View {
        TextField("Enter", text: $text)
    }
}
```

### Pattern 3: Shared ObservableObject

```swift
// Parent owns manager
struct ParentView: View {
    @StateObject private var manager = Manager()
    
    var body: some View {
        ChildView(manager: manager)
    }
}

// Child observes
struct ChildView: View {
    @ObservedObject var manager: Manager
    var body: some View {
        Text(manager.value)  // Auto-updates
    }
}
```

## üö® Common Mistakes & Fixes

### ‚ùå Creating object with @ObservedObject

```swift
// BAD
struct MyView: View {
    @ObservedObject var manager = Manager()  // NO! Recreates on every render
}

// GOOD
struct MyView: View {
    @StateObject private var manager = Manager()  // YES! Persists
}
```

### ‚ùå Updating state on background thread

```swift
// BAD
DispatchQueue.global().async {
    self.feedbackMessage = "Updated"  // NO! Crashes
}

// GOOD
DispatchQueue.global().async {
    let result = heavyComputation()
    DispatchQueue.main.async {
        self.feedbackMessage = result  // YES! Main thread
    }
}
```

### ‚ùå Passing @State directly

```swift
// BAD
ChildView(value: myState)  // NO! Passes value, not binding

// GOOD
ChildView(value: $myState)  // YES! Passes binding
```

### ‚ùå Using @State for complex objects

```swift
// BAD
@State private var imageProcessor = ImageProcessor()  // NO!

// GOOD
@StateObject private var imageProcessor = ImageProcessor()  // YES!
```

## ‚úÖ Best Practices from Klick

### ContentView.swift Pattern:

```swift
struct ContentView: View {
    // Managers - Use @StateObject
    @StateObject private var compositionManager = CompositionManager()
    
    // Local UI state - Use @State
    @State private var showSettings = false
    @State private var feedbackMessage: String?
    @State private var hasCameraPermission = false
    @State private var cameraLoading = true
    
    var body: some View {
        ZStack {
            // Pass manager to children
            CameraView(compositionManager: compositionManager)
            
            // Pass state as bindings
            if showSettings {
                FrameSettingsView(
                    isPresented: $showSettings,
                    isFacialRecognitionEnabled: $isFacialRecognitionEnabled
                )
            }
        }
    }
}
```

### PhotoManager.swift Pattern:

```swift
class PhotoManager: ObservableObject {
    static let shared = PhotoManager()
    
    // Observable state - Use @Published
    @Published var photos: [PhotoItem] = []
    
    // Internal state - Don't publish
    private let directory: URL
    private let fileManager = FileManager.default
    
    func savePhoto(_ image: UIImage) {
        let photo = PhotoItem(...)
        photos.insert(photo, at: 0)  // Triggers UI update
    }
}
```

### CameraView.swift Pattern:

```swift
struct CameraView: UIViewRepresentable {
    // Observed from parent - Use @ObservedObject
    @ObservedObject var compositionManager: CompositionManager
    
    // Two-way bindings - Use @Binding
    @Binding var triggerCapture: Bool
    @Binding var isFacialRecognitionEnabled: Bool
    
    class Coordinator {
        var parent: CameraView
        
        func captureOutput(...) {
            // Access parent's bindings
            if parent.isFacialRecognitionEnabled {
                // Process
            }
        }
    }
}
```

## üìä State Decision Tree

```
Need to store data?
‚îú‚îÄ Simple value (Bool, String, Int)?
‚îÇ  ‚îî‚îÄ Use @State private var
‚îú‚îÄ Complex object (ObservableObject)?
‚îÇ  ‚îú‚îÄ This view creates it?
‚îÇ  ‚îÇ  ‚îî‚îÄ Use @StateObject private var
‚îÇ  ‚îî‚îÄ Passed from parent?
‚îÇ     ‚îî‚îÄ Use @ObservedObject var
‚îî‚îÄ Need two-way binding to parent?
   ‚îî‚îÄ Use @Binding var (parent passes with $)
```

## üéØ Quick Checklist

When adding state:

1. **[ ]** Is it a simple value? ‚Üí `@State`
2. **[ ]** Is it an ObservableObject I create? ‚Üí `@StateObject`
3. **[ ]** Is it an ObservableObject passed to me? ‚Üí `@ObservedObject`
4. **[ ]** Do I need to modify parent's state? ‚Üí `@Binding`
5. **[ ]** Am I inside an ObservableObject? ‚Üí `@Published`

---

**For complete state management guide**: See `Documentation/2_Architecture/STATE_MANAGEMENT.md`
**For data flow patterns**: See `Documentation/2_Architecture/DATA_FLOW.md`
